<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="devCEQ">
<title>Running microsimulations in Stata • devCEQ</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running microsimulations in Stata">
<meta property="og:description" content="devCEQ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">devCEQ</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9024</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/microsim-stata.html">Running microsimulations in Stata</a>
    <a class="dropdown-item" href="../articles/r-workflow.html">Setting up a workflow in R</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Running microsimulations in Stata</h1>
                        <h4 data-toc-skip class="author">Eduard
Bukin</h4>
            
      
      
      <div class="d-none name"><code>microsim-stata.Rmd</code></div>
    </div>

    
    
<p>Microsimulation is a software product that uses micro-level data and
input parameters for simulating potential distributional effects of
alternative policies. Basic examples of such policies are personal
income taxes, indirect taxes, subsidies, and benefits in kind. Usually,
economists develop microsimulations in Stata connected with Excel, where
the first is used to execute data analysis and the later one is used for
providing policy inputs and visualizing the results. <a href="https://github.com/wbEPL/Example_FiscalSim" class="external-link">Example_FiscalSim</a>
is an example of such a microsimulation analysis.</p>
<p>Most microsimulation analyses are developed in Stata. They have a
predetermined structure that makes such Stata-based tools efficient,
transparent, and reproducible. Usually, such Stata tools consist of:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Raw data</strong>. It consists of household or
individual-level micro surveys with multiple data files that store
different bits of information, e.g. consumption records by goods or
groups of commodities for each household or individual, income levels by
sources and individuals, and assets owned by households. This data is
usually extremely detailed and only a fraction of it is used in the
simulation analysis. This data is stored in different formats (CSV,
excel, dta, etc.).</p></li>
<li><p><strong>Pre-simulation analysis.</strong> This is Stata code that
uses <strong>Raw data</strong> and produces <strong>pre-simulation
data</strong>. Its goal is to reduce the diversity of <strong>Raw data
sets</strong> of a very limited and restricted set of data files with
only a handful of variables used in the simulation. It is executed only
once and it is not re-executed when our policy parameters change.
<strong>Only the pre-simulation data is used in the following simulation
steps.</strong> Typical examples of such data that is computed at the
pre-simulation stage are grossed-up incomes and policy eligibility
criteria such as gender and age, or other local conditions on which
certain taxes or subsidy policies are applied.</p></li>
</ol>
<blockquote>
<p>Note. Often, when we convert Net income/consumption levels (after
taxation) into gross income/consumption, we apply policy parameters,
which existed at the time of data collection. These parameters should be
provided manually at the pre-simulation stage and they should never be
confused with the simulation-related policy parameters.</p>
</blockquote>
<ol start="3" style="list-style-type: decimal">
<li><p><strong>Policy parameters.</strong> These are numerical values
such as tax levels in % or subsidy levels in monetary value, which we
simulate at the simulation step. These are usually provided in the Excel
files and in the Stata code they are used as
<code>globals</code>.</p></li>
<li><p><strong>Simulation</strong> itself. This is a collection of
<code>.do</code> files that executes the simulation based on
pre-simulation data and policy parameters. These are executed
consecutively and gradually implement the simulation analysis.</p></li>
<li><p><strong>Results processing</strong>. A single data file with all
variables and income concepts was simulated during the analysis. Based
on it, we compute poverty and inequality measures as well as the
distributional effect of policies.</p></li>
</ol>
<p>Once the microsimulation is developed in Stata and it contains
clearly defined all five components explained above, we can commence
developing the microsimulation in R and subsequently the R Shiny
application with the microsimulation dashboard.</p>
<blockquote>
<p>Note. Usually, the first step is implemented in an ad-hoc way by
economists, who are not aware of best coding practices and fundamental
principles of data flow. Therefore, the first stage is rather chaotic.
In the second stage, considerable revision of the data flow and
simulation logic is happening. This two-stage approach is
resource-demanding, but it also reveals many limitations and problems of
the original analysis in Stata.</p>
</blockquote>
<div class="section level2">
<h2 id="example-of-a-microsimulation-in-stata">Example of a microsimulation in Stata<a class="anchor" aria-label="anchor" href="#example-of-a-microsimulation-in-stata"></a>
</h2>
<p>As an example, let us follow up with a “dummy” version of such a
microsimulation: <a href="https://github.com/wbEPL/Example_FiscalSim" class="external-link">Example_FiscalSim</a>.
It was developed for the training of future microsim developers and it
exemplifies the best practices of fiscal microsimulation
development.</p>
<div class="section level3">
<h3 id="setting-up-the-working-directory">Setting up the working directory<a class="anchor" aria-label="anchor" href="#setting-up-the-working-directory"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Create a folder on your cloud drive (or better a not synchronized
drive), where you will later develop R Shiny translation of the
microsimulation.</p>
<p>In my case, this is folder <code>EPL/devCEQaux</code>.</p>
</li>
<li>
<p>Clone into this folder example microsimulation in Stata from:</p>
<ul>
<li>
<a href="https://github.com/wbEPL/Example_FiscalSim" class="external-link uri">https://github.com/wbEPL/Example_FiscalSim</a>.</li>
</ul>
</li>
<li>
<p>Open the <code>Example_FiscalSim</code> folder and explore its
content.</p>
<p>As you can see from the directory tree below,
<code>Example_FiscalSim</code> contains a few folders.</p>
<p><code>/01.Data/</code> folder in turn has three sub folders
<code>/01.pre-simulation/</code>, <code>/02.intermediate/</code>, and
<code>/03.simulation-results/</code> and two data files with raw data
<code>Example_FiscalSim_dem_inc_data_raw.dta</code>, and
<code>Example_FiscalSim_exp_data_raw.dta</code>. Ultimately, the raw
data should be outside of this project, but we packed it together for
simplicity.</p>
<p><code>/01.Data/01.pre-simulation/</code> is the place where
pre-simulation data is stored as per the data flow structure above.</p>
<p><code>/02.Dofile/</code> is the place where all simulation code is
being developed. Key simulation code is in scripts
<code>01_.._.do</code> to <code>12_output.do</code>.</p>
<p><code>/02.Dofile/00_master.do</code> is the master script from which
we will be running the simulation.</p>
<p><code>/03.Tool/Example_FiscalSim.xlsx</code> is the Excel file with
all simulation inputs (policy parameters, tax rates, and subsidies) and
outputs (poverty and inequality estimates, incidences, etc.).</p>
</li>
</ol>
<pre><code>./devCEQaux/
└── Example_FiscalSim
    ├── 01.Data
    │   ├── 01.pre-simulation
    │   ├── 02.intermediate
    │   ├── 03.simulation-results
    │   ├── Example_FiscalSim_dem_inc_data_raw.dta
    │   └── Example_FiscalSim_exp_data_raw.dta
    ├── 02.Dofile
    │   ├── 00_master.do
    │   ├── 01_input_data.do
    │   ├── 02_gross_market_income.do
    │   ├── 03_net_expenditures.do
    │   ├── 04_income_uprating.do
    │   ├── 05_SSC_direct_taxes.do
    │   ├── 06_pensions_direct_transfers.do
    │   ├── 07_expenditure_adjustment.do
    │   ├── 08_indirect_subsidies.do
    │   ├── 09_indirect_taxes.do
    │   ├── 10_inkind_transfers.do
    │   ├── 11_income_concepts.do
    │   ├── 12_output.do
    │   ├── ados
    │   │   ├── ...
    │   └── Example_FiscalSim.stpr
    ├── 03.Tool
    │   └── Example_FiscalSim.xlsx
    └── README.md</code></pre>
</div>
<div class="section level3">
<h3 id="running-pre-simulation-in-stata">Running pre-simulation in Stata<a class="anchor" aria-label="anchor" href="#running-pre-simulation-in-stata"></a>
</h3>
<p>To run the Stata pre-simulation, we need to:</p>
<ol style="list-style-type: decimal">
<li><p>Open <code>/02.Dofile/00_master.do</code>.</p></li>
<li><p>Set the global variable <code>path</code> in lines 10-30 to
<code>/Example_FiscalSim/</code> and save it.</p></li>
<li>
<p>Execute the <code>/02.Dofile/00_master.do</code> from the
beginning to the <code>*Simulation stage</code> (Lines 1-89).</p>
<p>This will execute the pre-simulation part of your analysis creating
the pre-simulation data sets (see folder structure below).</p>
<p>You may notice that now, more data files are added to the
<code>01.Data/01.pre-simulation</code> folder. These files are used in
the simulation and they do not change from simulation to simulation.
They do not change if policy parameters are changing. They will also
serve as a backbone of the simulation translation to R.</p>
<p>If an error is prompted, troubleshoot it. Most likely the global
variable <code>path</code> was not set properly.</p>
</li>
</ol>
<pre><code>./devCEQaux/
└── Example_FiscalSim
    ├── 01.Data
    │   ├── 01.pre-simulation
    │   │   ├── Example_FiscalSim_dem_data_SY.dta
    │   │   ├── Example_FiscalSim_dem_inc_data.dta
    │   │   ├── Example_FiscalSim_electr_data.dta
    │   │   ├── Example_FiscalSim_exp_data_SY.dta
    │   │   └── Example_FiscalSim_market_income_data_SY.dta
    │   ├── 02.intermediate
    │   ├── 03.simulation-results
    │   ├── Example_FiscalSim_dem_inc_data_raw.dta
    │   └── Example_FiscalSim_exp_data_raw.dta
    ├── 02.Dofile
    │   ├── ...
    │   └── ados
    │       ├── ...
    ├── 03.Tool
    │   └── Example_FiscalSim.xlsx
    └── README.md</code></pre>
</div>
<div class="section level3">
<h3 id="executing-full-simulation-in-stata">Executing full simulation in Stata<a class="anchor" aria-label="anchor" href="#executing-full-simulation-in-stata"></a>
</h3>
<p>To run the full simulation in Stata, we need to:</p>
<ol style="list-style-type: decimal">
<li><p>Open <code>/02.Dofile/00_master.do</code> with previous changes
and make sure that the pre-simulation step was executed
correctly.</p></li>
<li><p>Comment out the pre-simulation stage (lines 83-89).</p></li>
<li><p>Execute the full simulation from the beginning to the end (line 1
to the end of the <code>00_master.do</code>)</p></li>
<li><p>An Excel file with the simulation results will open in the end
and you will be able to explore the simulation results.</p></li>
</ol>
<p><img src="images/stata-run-workflow.gif"></p>
</div>
<div class="section level3">
<h3 id="saving-intermediate-results-from-stata">Saving intermediate results from Stata<a class="anchor" aria-label="anchor" href="#saving-intermediate-results-from-stata"></a>
</h3>
<p>Sometimes, when simulations are very long, or we are implementing a
tedious process of simulation translation, and re-implementing some
complex analysis in R, we might need to save intermediate data sets from
Stata. Please make sure that you are saving such data in the
<code>/01.Data/02.intermediate/</code> folder using regular Stata
commands such as:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="st">"${data}</span><span class="ch">\02</span><span class="st">.intermediate\interm_data_1.dta"</span>, <span class="kw">replace</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Eduard Bukin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
